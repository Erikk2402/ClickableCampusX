<head>
    <title>ClickableCampus V2</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="map"></div>
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Add Location Note</h2>
            <form id="note-form">
                <label for="note-title">Title:</label>
                <input type="text" id="note-title" required><br>
                <label for="note-description">Description:</label>
                <textarea id="note-description" required></textarea><br>
                <button type="submit">Save</button>
            </form>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
    <script src="leaflet.js" crossorigin="anonymous" integrity="sha384-cxOPjt7s7Iz04uaHJceBmS+qpjv2JkIHNVcuOrM+YHwZOmJGBXI00mdUXEq65HTH" data-no-instant></script>
    <script src="script.js"></script>

<script>
    // Initialize the map
    var map = L.map('map').setView([53.41874, -7.90476], 18);

    // Add the tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
        maxZoom: 19
    }).addTo(map);

    // Load map data from the server
    fetch('server.php')
        .then(response => response.json())
        .then(data => {
            console.log(data);
            // Process the data and create markers
            data.forEach(location => {
                L.marker([location.lat, location.lng])
                    .bindPopup(location.title)
                    .addTo(map);

                // Add red circle marker
                L.circleMarker([location.lat, location.lng], {
                    radius: 6,
                    color: 'red',
                    fillColor: 'red',
                    fillOpacity: 1
                }).addTo(map);
            });
        });

    // Add event listener for clicking on the map
    map.on('click', function (e) {
        openModal(e.latlng);
    });

    // Open the modal with the form
    function openModal(latlng) {
        document.getElementById('note-title').value = '';
        document.getElementById('note-description').value = '';

        var modal = document.getElementById('modal');
        var closeButton = document.getElementsByClassName('close')[0];

        modal.style.display = 'block';

        closeButton.onclick = function () {
            closeModal();
        };

        window.onclick = function (event) {
            if (event.target == modal) {
                closeModal();
            }
        };

        var form = document.getElementById('note-form');
        form.onsubmit = function (event) {
            event.preventDefault();
            saveNoteToDatabase(latlng);
            closeModal();
        };
    }

    // Close the modal
    function closeModal() {
        var modal = document.getElementById('modal');
        modal.style.display = 'none';
    }

    // Save the note to the database
    function saveNoteToDatabase(latlng) {
        var title = document.getElementById('note-title').value;
        var description = document.getElementById('note-description').value;

        fetch('server.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'lat=' + latlng.lat + '&lng=' + latlng.lng + '&title=' + title + '&description=' + description,
        })
            .then(response => response.text())
            .then(data => {
                console.log(data);
                // Refresh the map to display the newly added marker
                location.reload();
            });
    }

</script>

</html>